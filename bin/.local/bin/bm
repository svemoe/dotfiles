#!/bin/sh

[ -z "$BM_DIR" ] \
  && echo "No directory specified!" \
  && exit 1

export GIT_WORK_TREE="$BM_DIR"
export GIT_DIR="$BM_DIR/.git"

get_url () {
	sed -n "$1p" "$BM_DIR/$2" | awk '{print $1}'
}

add () {
	url="$1"
	cat $BM_DIR/{unread,favorite,archive} | grep "$url" \
	  && "$NOTIFY" "Already saved!" \
	  && exit
	[ -z "$2" ] \
	  && title="$(curl --compressed --location $url \
	    | grep -Eo '<title>.*</title>' \
	    | sed -E 's-</?title>--g')" \
	  || title="$2"
	
	echo "$url $title" >> $BM_DIR/unread
	
	"$NOTIFY" "Bookmark added! ($title)"
}

list () {
	cat -n "$BM_DIR/$1"
}

move () {
	sed -n "$1p" "$BM_DIR/$2" >> "$BM_DIR/$3"
	delete "$1" "$2"
}

delete () {
	sed -i "$1d" "$BM_DIR/$2"
}

open () {
	url="$(get_url $1 $2)"
	xdg-open "$url"
}

interactive () {
	list="$1"
	actions="open\narchive\nfavorite\nunread\ndelete\n"
	while :; do
		line="$(list "$list" | fzf | awk '{print $1}')"
		if [ -z "$line" ]; then exit; fi
		action="$(printf "$actions" | grep -v "$list" | fzf)"
		if [ -z "$action" ]; then exit; fi
		case "$action" in
			unread|favorite|archive) move "$line" "$list" "$action" ;;
			open|delete) "$action" "$line" "$list" ;;
		esac
	done
}

sync () {
	git diff --quiet || git commit -am "Update"
	git pull && git push
}

help () {
	bin="$(basename $1)"
	echo "Usage: $bin [COMMAND]"
	echo "Or:    $bin URL [TITLE]"
	echo ""
	echo "Commands:"
	cat $1 | grep -E "^\s*[a-z|]+)" | awk '{print "\t"$1}'
}

if [ -z "$1" ]; then "$0" "unread"; exit; fi
case "$1" in
	unread|favorite|archive) interactive "$1" ;;
	git|sync) "$@"; exit ;;
	http://*|https://*) add "$1" "$2"; exit ;;
	*) help "$0"; exit ;;
esac
