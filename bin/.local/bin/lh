#!/bin/sh

gui=false
menu="fzf -i"

open () {
	url="$(echo "$1" | sed 's/?.*$//')"

	case $url in
		*.png|*.jpg) curl $url | setsid -f $IMAGE_VIEWER -;;
		*.mp3|*.ogg|*youtube.com/watch*) setsid -f mpv --force-window $1 > /dev/null 2>&1 & ;;
		*) $BROWSER $1 ;;
	esac
}

qr () {
	[ $gui = true ] && \
		qrencode -o - "$1" | imv - || \
		qrencode -t UTF8 "$1"
}

clipboard () {
	url="$1"
	echo "$url" | xclip -selection "clipboard"
}

download () {
	url="$1"
	name="$(echo "$url" | sed 's_/$__' | rev | cut -d'/' -f1 | rev | sed 's_\..*__')"
	pandoc --verbose -o "$BM_DIR/saved/$name.epub" "$url"
}

bookmark () {
	bm "$1"
}

_choose () {
	[ $gui = true ] && menu="dmenu"
	action="$(grep '^[a-z]\+ ()' | sed 's/[^a-z]//g' | $menu)"
	$action "$1"
}

while [ $# -gt 0 ]; do
	case $1 in
		-g) gui=true ;;
		-*) echo "Unknown option: $1" ;;
		-o) open $2 ;;
		*)
			[ $# -eq 2 ] && "$1" "$2" && exit
			[ $# -eq 1 ] && cat "$0" | _choose "$1"
			;;
	esac
	shift
done

