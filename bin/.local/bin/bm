#!/bin/sh

selector=fzf

[ -z "$BM_DIR" ] \
  && echo "No directory specified!" \
  && exit 1

export GIT_WORK_TREE="$BM_DIR"
export GIT_DIR="$BM_DIR/.git"

get_url () {
	sed -n "$1p" "$BM_DIR/$2" | awk '{print $1}'
}

add () {
	url="$1"
	cat $BM_DIR/{unread,favorite,archive} | grep "$url" \
	  && "$NOTIFY" "Already saved!" \
	  && exit
	[ -z "$2" ] \
	  && title="$(curl --compressed --location $url \
	    | grep -Eo '<title>.*</title>' \
	    | sed -E 's-</?title>--g')" \
	  || title="$2"
	
	echo "$url $title" >> $BM_DIR/unread
	
	"$NOTIFY" "Bookmark added! ($title)"
}

random () {
	shuf -n 1 "$BM_DIR/unread" | awk '{print $1}' | xargs xdg-open
}

move () {
	sed -n "$1p" "$BM_DIR/$2" >> "$BM_DIR/$3"
	delete "$1" "$2"
}

delete () {
	sed -i "$1d" "$BM_DIR/$2"
}

open () {
	url="$(get_url $1 $2)"
	"$LINK_HANDLER" "$url"
}

download () {
	url="$(get_url $1 $2)"
	title="$(echo "$url" | sed 's_/$__' | rev | cut -d'/' -f1 | rev)"
	echo $title
	pandoc --verbose -o "$BM_DIR/saved/$title.epub" "$url"
}

interactive () {
	list="$1"
	actions="open\narchive\nfavorite\nunread\ndelete\ndownload\n"
	while :; do
		line="$(cat -n "$BM_DIR/$1" | "$selector" | awk '{print $1}')"
		if [ -z "$line" ]; then exit; fi
		action="$(printf "$actions" | grep -v "$list" | "$selector")"
		if [ -z "$action" ]; then exit; fi
		case "$action" in
			unread|favorite|archive) move "$line" "$list" "$action" ;;
			open|delete|download) "$action" "$line" "$list" ;;
		esac
	done
}

sync () {
	git diff --quiet || git commit -am "Update"
	git pull && git push
	rsync -avzu git@svenmoeller.xyz:/home/git/documents/bookmarks/cache.db "$BM_DIR"/cache.db
	rsync -avzu "$BM_DIR"/cache.db git@svenmoeller.xyz:/home/git/documents/bookmarks/cache.db
}

html () {
	echo '<!DOCTYPE html>'
	echo '<html>'
	echo '<head>'
	echo '<meta charset="utf-8">'
	echo '<title>Bookmarks</title>'
	echo '</head>'
	echo '<body>'
	echo "<h1>Bookmarks</h1>"
	to_html favorite
	to_html unread
	echo '</body>'
	echo '</html>'
}

to_html ()
{
	title="$(echo "$1" | head -c 1 | tr [:lower:] [:upper:])$(echo "$1" | tail -c +2)"
	echo "<h2>$title</h2>"
	echo "<ul>"
	sed -e 's_^\(\S*\)\s*$_\1 \1_' -e 's_\s_">_' "$BM_DIR/$1" -e 's_^_<li><a href="_' -e 's_$_</a></li>_'
	echo "</ul>"
}

help () {
	bin="$(basename $1)"
	echo "Usage: $bin [COMMAND]"
	echo "Or:    $bin URL [TITLE]"
	echo ""
	echo "Commands:"
	grep -E "^	[a-z|]+)" $1 | sed 's/)//' | tr '|' '\n' | awk '{print "\t"$1}'
}

if [ -z "$1" ]; then "$0" "unread"; exit; fi
case "$1" in
	unread|favorite|archive)
		interactive "$1" ;;
	git|sync|html|random)
		"$@"; exit ;;
	http://*|https://*)
		add "$1" "$2"; exit ;;
	*)
		help "$0"; exit ;;
esac
