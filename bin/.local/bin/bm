#!/bin/sh

[ -z "$BM_DIR" ] \
  && echo "No directory specified!" \
  && exit 1

export GIT_WORK_TREE="$BM_DIR"
export GIT_DIR="$BM_DIR/.git"

_get_url () {
	[ -z "$2" ] \
	  && file="$urls_file" \
	  || file="$2"
	sed -n "$1p" "$file" | awk '{print $1}'
}

add () {
	url="$1"
	cat "$urls_file" "$archive_file" | grep "$url" \
	  && "$NOTIFY" "Already saved!" \
	  && exit
	[ -z "$2" ] \
	  && title="$(curl --compressed --location $url \
	    | grep -Eo '<title>.*</title>' \
	    | sed -E 's-</?title>--g')" \
	  || title="$2"
	
	echo "$url $title" >> "$urls_file"
	
	"$NOTIFY" "Bookmark added! ($title)"
}

list () {
	cat -n "$BM_DIR/$1"
}

move () {
	sed -n "$1p" "$2" >> "$3"
	delete "$1" "$2"
}

delete () {
	sed -i "$1d" "$2"
}

archive () {
	move "$1" "$2" "$0"
}

favorite () {
	move "$1" "$2" "$0"
}

unread () {
	move "$1" "$2" "$0"
}

open () {
	xdg-open "$(_get_url "$1")"
}

interactive () {
	line="$(list "$1" | fzf | awk '{print $1}')"
	if [ -z "$line" ]; then exit; fi
	action="$(printf "open\narchive\ndelete\n" | fzf)"
	if [ -z "$action" ]; then exit; fi
	"$action" "$line" "$1"
}

sync () {
	git diff --quiet || git commit -am "Update"
	git pull && git push
}

help () {
	echo "Usage: $(basename $1) [COMMAND]"
	echo "Or:    $(basename $1) URL [TITLE]"
	echo ""
	echo "Commands:"
	cat $1 | grep -E "^\s*[a-z|]+)" | awk '{print "\t"$1}'
}

if [ -z "$1" ]; then "$0" "unread"; exit; fi
case "$1" in
	unread|favorite|archive) interactive "$1" ;;
	git|sync) "$@"; exit ;;
	http://*|https://*) add "$1" "$2"; exit ;;
	*) help "$0"; exit ;;
esac
