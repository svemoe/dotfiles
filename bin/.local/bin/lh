#!/bin/sh

gui=false
menu="fzf -i"

open () {
	url="$(echo "$1" | sed 's/?.*$//')"

	case $url in
		*.png|*.jpg|*.jpeg) curl $url | setsid -f $IMAGE_VIEWER -;;
		*.mp3|*.ogg|*youtube.com/watch*|*invidious.snopyta.org/watch*)
			setsid -f mpv --force-window $1 > /dev/null 2>&1 & ;;
		*) $BROWSER $1 ;;
	esac
}

qr () {
	[ $gui = true ] && \
		qrencode -o - "$1" | imv - || \
		qrencode -t UTF8 "$1"
}

clipboard () {
	url="$1"
	echo "$url" | xclip -selection "clipboard"
}

download () {
	if [ "$(uname -o)" != "Android" ]; then
		name="$(echo "$1" | sed 's_/$__' | rev | cut -d'/' -f1 | rev | sed 's_\..*__')"
		pandoc --verbose -o "$BM_DIR/saved/$name.epub" "$1"
	else
		ssh git@svenmoeller.xyz -- BM_DIR=/home/git/documents/bookmarks .local/bin/lh download "$1"
	fi
}

bookmark () {
	bm "$1"
}

choose () {
	[ $gui = true ] && menu="dmenu"
	action="$(grep '^[a-z]\+ ()' | sed 's/[^a-z]//g' | $menu)"
	$action "$1"
}

case $1 in
	-g) gui=true ;;
	-o) open $2 ;;
	-c) choose ;;
	-*) echo "Unknown option: $1" ;;
	*)
		[ $# -eq 2 ] && "$1" "$2" && exit
		[ $# -eq 1 ] && cat "$0" | open "$1"
		;;
esac
